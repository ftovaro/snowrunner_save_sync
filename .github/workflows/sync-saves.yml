name: Sync SnowRunner Saves

on:
  push:
    branches:
      - ftovaro
      - svanegasg
    paths:
      - 'remote/**'
      - 'remotecache.vdf'

permissions:
  contents: write

jobs:
  merge-saves:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all branches
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Determine source branch
        id: branch
        run: |
          BRANCH="${GITHUB_REF#refs/heads/}"
          echo "source=$BRANCH" >> $GITHUB_OUTPUT
          if [ "$BRANCH" = "ftovaro" ]; then
            echo "other=svanegasg" >> $GITHUB_OUTPUT
          else
            echo "other=ftovaro" >> $GITHUB_OUTPUT
          fi
      
      - name: Configure git
        run: |
          git config user.name "SnowRunner Save Sync Bot"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config core.autocrlf false
          git config core.eol lf
      
      - name: Fetch other player's branch
        run: |
          git fetch origin ${{ steps.branch.outputs.other }}
      
      - name: Create temporary directories
        run: |
          mkdir -p /tmp/ftovaro_save
          mkdir -p /tmp/svanegasg_save
          mkdir -p /tmp/merged_ftovaro
          mkdir -p /tmp/merged_svanegasg
      
      - name: Extract ftovaro saves
        run: |
          git checkout ftovaro
          cp -r remote /tmp/ftovaro_save/
          cp remotecache.vdf /tmp/ftovaro_save/ || true
      
      - name: Extract svanegasg saves
        run: |
          git checkout svanegasg
          cp -r remote /tmp/svanegasg_save/
          cp remotecache.vdf /tmp/svanegasg_save/ || true
      
      - name: Merge saves for ftovaro (preserve ftovaro customizations)
        run: |
          python3 scripts/merge_saves.py \
            /tmp/ftovaro_save \
            /tmp/svanegasg_save \
            /tmp/merged_ftovaro \
            --preserve ftovaro
      
      - name: Merge saves for svanegasg (preserve svanegasg customizations)
        run: |
          python3 scripts/merge_saves.py \
            /tmp/ftovaro_save \
            /tmp/svanegasg_save \
            /tmp/merged_svanegasg \
            --preserve svanegasg
      
      - name: Update ftovaro branch
        run: |
          git checkout ftovaro
          # Copy only the JSON save files and remotecache, not the binary fog/sts files
          cp /tmp/merged_ftovaro/remote/CompleteSave.cfg remote/
          cp /tmp/merged_ftovaro/remote/CommonSslSave.cfg remote/
          cp /tmp/merged_ftovaro/remotecache.vdf . 2>/dev/null || true
          
          # Copy binary fog/sts/mudmaps files (only if new or changed)
          # Strip any null terminators from binary files (they shouldn't have them)
          for file in /tmp/merged_ftovaro/remote/fog_*.cfg /tmp/merged_ftovaro/remote/sts_*.cfg /tmp/merged_ftovaro/remote/sts_mudmaps_*.cfg; do
            if [ -f "$file" ]; then
              basename=$(basename "$file")
              # Remove null terminator if present
              if tail -c 1 "$file" | xxd -p | grep -q "00$"; then
                truncate -s -1 "$file"
              fi
              if [ ! -f "remote/$basename" ] || ! cmp -s "$file" "remote/$basename"; then
                cp "$file" "remote/$basename"
                echo "Updated $basename"
              fi
            fi
          done
          
          # Add null terminators ONLY to CompleteSave.cfg and CommonSslSave.cfg
          for file in remote/CompleteSave.cfg remote/CommonSslSave.cfg; do
            if [ -f "$file" ]; then
              # Check if file ends with null byte, if not add it
              if ! tail -c 1 "$file" | xxd -p | grep -q "00$"; then
                printf '\x00' >> "$file"
                echo "Added null terminator to $file"
              fi
            fi
          done
          
          # Only commit if there are changes
          if ! git diff --quiet HEAD; then
            git add --force remote/*.cfg remotecache.vdf
            git commit -m "ðŸ”„ Auto-sync: Merged progress from ${{ steps.branch.outputs.source }}"
            git push origin ftovaro
          else
            echo "No changes to commit for ftovaro"
          fi
      
      - name: Update svanegasg branch
        run: |
          git checkout svanegasg
          # Copy only the JSON save files and remotecache, not the binary fog/sts files
          cp /tmp/merged_svanegasg/remote/CompleteSave.cfg remote/
          cp /tmp/merged_svanegasg/remote/CommonSslSave.cfg remote/
          cp /tmp/merged_svanegasg/remotecache.vdf . 2>/dev/null || true
          
          # Copy binary fog/sts/mudmaps files (only if new or changed)
          # Strip any null terminators from binary files (they shouldn't have them)
          for file in /tmp/merged_svanegasg/remote/fog_*.cfg /tmp/merged_svanegasg/remote/sts_*.cfg /tmp/merged_svanegasg/remote/sts_mudmaps_*.cfg; do
            if [ -f "$file" ]; then
              basename=$(basename "$file")
              # Remove null terminator if present
              if tail -c 1 "$file" | xxd -p | grep -q "00$"; then
                truncate -s -1 "$file"
              fi
              if [ ! -f "remote/$basename" ] || ! cmp -s "$file" "remote/$basename"; then
                cp "$file" "remote/$basename"
                echo "Updated $basename"
              fi
            fi
          done
          
          # Add null terminators ONLY to CompleteSave.cfg and CommonSslSave.cfg
          for file in remote/CompleteSave.cfg remote/CommonSslSave.cfg; do
            if [ -f "$file" ]; then
              # Check if file ends with null byte, if not add it
              if ! tail -c 1 "$file" | xxd -p | grep -q "00$"; then
                printf '\x00' >> "$file"
                echo "Added null terminator to $file"
              fi
            fi
          done
          
          # Only commit if there are changes
          if ! git diff --quiet HEAD; then
            git add --force remote/*.cfg remotecache.vdf
            git commit -m "ðŸ”„ Auto-sync: Merged progress from ${{ steps.branch.outputs.source }}"
            git push origin svanegasg
          else
            echo "No changes to commit for svanegasg"
          fi
      
      - name: Create merge summary
        if: always()
        run: |
          echo "## ðŸŽ® Save Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ steps.branch.outputs.source }} branch push" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Both branches updated with merged progress" >> $GITHUB_STEP_SUMMARY
          echo "- ftovaro: Received shared progress + their own truck customizations" >> $GITHUB_STEP_SUMMARY
          echo "- svanegasg: Received shared progress + their own truck customizations" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next step:** Pull from your branch to get the synced save" >> $GITHUB_STEP_SUMMARY
