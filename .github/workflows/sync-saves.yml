name: Update Money in Saves

on:
  push:
    branches:
      - ftovaro
      - svanegasg

permissions:
  contents: write

jobs:
  update-money:
    runs-on: ubuntu-latest
    outputs:
      trigger: ${{ steps.branch.outputs.trigger }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Determine branch and check for trigger
        id: branch
        run: |
          BRANCH="${GITHUB_REF#refs/heads/}"
          echo "current=$BRANCH" >> $GITHUB_OUTPUT
          
          # Get commit message
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "commit_message=$COMMIT_MSG" >> $GITHUB_OUTPUT
          
          # Check if commit message contains [trigger]
          if echo "$COMMIT_MSG" | grep -qi "\[trigger\]"; then
            echo "trigger=true" >> $GITHUB_OUTPUT
            echo "ðŸš¨ TRIGGER ACTIVATED - Special operation requested"
          else
            echo "trigger=false" >> $GITHUB_OUTPUT
            echo "ðŸ“ Normal workflow - no trigger"
          fi
      
      - name: Configure git
        run: |
          git config user.name "SnowRunner Save Sync Bot"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Update money in CompleteSave.cfg
        run: |
          echo "Updating money for ${{ steps.branch.outputs.current }} branch..."
          python3 scripts/simple_money_update.py
      
      - name: Display truck customization paths
        if: steps.branch.outputs.trigger == 'true'
        run: |
          echo "ðŸ“‹ Truck customization reference:"
          python3 scripts/truck_customization_paths.py "${{ steps.branch.outputs.trigger }}"
      
      - name: Commit changes if money was updated
        run: |
          if ! git diff --quiet HEAD remote/CompleteSave.cfg; then
            git add remote/CompleteSave.cfg
            git commit -m "ðŸ’° Auto-update: Ensured minimum money ($200k)"
            git push origin ${{ steps.branch.outputs.current }}
            echo "Money updated and committed"
          else
            echo "No money update needed (already above minimum)"
          fi
      
      - name: Create summary
        if: always()
        run: |
          echo "## ðŸ’° Money Update Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ steps.branch.outputs.current }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Money checked and updated if needed" >> $GITHUB_STEP_SUMMARY
          echo "- Minimum money: \$200,000" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next step:** Pull from your branch to get the updated save" >> $GITHUB_STEP_SUMMARY
  
  sync-to-main:
    runs-on: ubuntu-latest
    needs: update-money
    if: needs.update-money.outputs.trigger == 'true' && (github.ref == 'refs/heads/ftovaro' || github.ref == 'refs/heads/svanegasg')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Get source branch
        id: source
        run: |
          BRANCH="${GITHUB_REF#refs/heads/}"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "ðŸ”„ Syncing $BRANCH â†’ main (preserving truck customizations)"
      
      - name: Configure git
        run: |
          git config user.name "SnowRunner Save Sync Bot"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Fetch main branch CompleteSave.cfg
        run: |
          SOURCE_BRANCH="${{ steps.source.outputs.branch }}"
          
          echo "Fetching main branch..."
          git fetch origin main
          
          echo "Extracting main's CompleteSave.cfg..."
          git show origin/main:remote/CompleteSave.cfg > main_CompleteSave.cfg || echo "No main save found"
      
      - name: Sync saves preserving truck customizations
        run: |
          if [ -f main_CompleteSave.cfg ]; then
            python3 scripts/sync_to_main.py main_CompleteSave.cfg synced_CompleteSave.cfg
            cp synced_CompleteSave.cfg remote/CompleteSave.cfg
          else
            echo "âš ï¸  No main save to compare - using branch save as-is"
            cp remote/CompleteSave.cfg synced_CompleteSave.cfg
          fi
      
      - name: Push to main branch
        run: |
          SOURCE_BRANCH="${{ steps.source.outputs.branch }}"
          
          echo "Checking out main..."
          git checkout main
          
          echo "Copying synced save..."
          cp synced_CompleteSave.cfg remote/CompleteSave.cfg
          
          echo "Checking for changes..."
          if ! git diff --quiet HEAD remote/CompleteSave.cfg; then
            git add remote/CompleteSave.cfg
            git commit -m "ðŸ”„ Auto-sync from $SOURCE_BRANCH - preserved truck customizations [triggered]"
            git push origin main
            echo "âœ… Successfully synced $SOURCE_BRANCH to main"
          else
            echo "â„¹ï¸ No changes to sync"
          fi
      
      - name: Create sync summary
        if: always()
        run: |
          echo "## ðŸ”„ Sync to Main Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Source:** ${{ steps.source.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** main" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… CompleteSave.cfg synced with truck customizations preserved" >> $GITHUB_STEP_SUMMARY
          echo "- New trucks from branch added to main" >> $GITHUB_STEP_SUMMARY
          echo "- Existing trucks kept their main customizations" >> $GITHUB_STEP_SUMMARY
          echo "- Progress, money, and discoveries synced" >> $GITHUB_STEP_SUMMARY
  
  sync-to-other-branch:
    runs-on: ubuntu-latest
    needs: sync-to-main
    if: needs.update-money.outputs.trigger == 'true' && (github.ref == 'refs/heads/ftovaro' || github.ref == 'refs/heads/svanegasg')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Determine target branch
        id: target
        run: |
          SOURCE_BRANCH="${GITHUB_REF#refs/heads/}"
          if [ "$SOURCE_BRANCH" = "ftovaro" ]; then
            TARGET_BRANCH="svanegasg"
          else
            TARGET_BRANCH="ftovaro"
          fi
          echo "source=$SOURCE_BRANCH" >> $GITHUB_OUTPUT
          echo "target=$TARGET_BRANCH" >> $GITHUB_OUTPUT
          echo "ðŸ”„ Syncing main â†’ $TARGET_BRANCH (preserving truck customizations)"
      
      - name: Configure git
        run: |
          git config user.name "SnowRunner Save Sync Bot"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Fetch target branch CompleteSave.cfg
        run: |
          TARGET_BRANCH="${{ steps.target.outputs.target }}"
          
          echo "Fetching $TARGET_BRANCH branch..."
          git fetch origin $TARGET_BRANCH
          
          echo "Extracting $TARGET_BRANCH's CompleteSave.cfg..."
          git show origin/$TARGET_BRANCH:remote/CompleteSave.cfg > target_CompleteSave.cfg || echo "No target save found"
      
      - name: Sync saves preserving truck customizations
        run: |
          # main's CompleteSave.cfg is already checked out
          if [ -f target_CompleteSave.cfg ]; then
            python3 scripts/sync_to_main.py target_CompleteSave.cfg synced_target_CompleteSave.cfg
          else
            echo "âš ï¸  No target save to compare - using main save as-is"
            cp remote/CompleteSave.cfg synced_target_CompleteSave.cfg
          fi
      
      - name: Push to target branch
        run: |
          TARGET_BRANCH="${{ steps.target.outputs.target }}"
          
          echo "Checking out $TARGET_BRANCH..."
          git checkout $TARGET_BRANCH
          
          echo "Copying synced save..."
          cp synced_target_CompleteSave.cfg remote/CompleteSave.cfg
          
          echo "Checking for changes..."
          if ! git diff --quiet HEAD remote/CompleteSave.cfg; then
            git add remote/CompleteSave.cfg
            git commit -m "ðŸ”„ Auto-sync from main - preserved truck customizations [triggered by ${{ steps.target.outputs.source }}]"
            git push origin $TARGET_BRANCH
            echo "âœ… Successfully synced main to $TARGET_BRANCH"
          else
            echo "â„¹ï¸ No changes to sync"
          fi
      
      - name: Create sync summary
        if: always()
        run: |
          echo "## ðŸ”„ Sync to Other Branch Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Source:** main (from ${{ steps.target.outputs.source }})" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** ${{ steps.target.outputs.target }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… CompleteSave.cfg synced with truck customizations preserved" >> $GITHUB_STEP_SUMMARY
          echo "- Progress from ${{ steps.target.outputs.source }} shared with ${{ steps.target.outputs.target }}" >> $GITHUB_STEP_SUMMARY
          echo "- ${{ steps.target.outputs.target }}'s truck customizations preserved" >> $GITHUB_STEP_SUMMARY
          echo "- New trucks, money, and discoveries synced" >> $GITHUB_STEP_SUMMARY
